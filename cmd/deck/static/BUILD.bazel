package(default_visibility = ["//visibility:public"])

load("@build_bazel_rules_nodejs//:defs.bzl", "rollup_bundle")
load("@build_bazel_rules_typescript//:defs.bzl", "ts_library")

ts_library(
    name = "api",
    srcs = glob(["api/**/*.ts"]),
)

rollup_bundle(
    name = "index",
    srcs = [
        "fuzzy-search.js",
        "script.js",
    ],
    entry_point = "prow/cmd/deck/static/script.js",
    deps = [
        "@npm//:moment",
    ],
)

ts_library(
    name = "plugin_help",
    srcs = glob(["plugin-help/*.ts"]) + ["vendor.d.ts"],
    deps = [
        ":api",
    ],
)

rollup_bundle(
    name = "plugin_help_bundle",
    entry_point = "prow/cmd/deck/static/plugin-help/plugin-help",
    deps = [
        ":plugin_help",
        "@npm//:dialog-polyfill",
    ],
)

rollup_bundle(
    name = "pr",
    srcs = [
        "pr-script.js",
    ],
    entry_point = "prow/cmd/deck/static/pr-script.js",
    deps = [
        "@npm//:dialog-polyfill",
    ],
)

ts_library(
    name = "tide",
    srcs = glob(["tide/*.ts"]),
    deps = [
        ":api",
    ],
)

rollup_bundle(
    name = "tide_bundle",
    entry_point = "prow/cmd/deck/static/tide/tide",
    deps = [
        ":tide",
    ],
)

ts_library(
    name = "command_help",
    srcs = glob(["command-help/*.ts"]) + ["vendor.d.ts"],
    deps = [
        ":api",
    ],
)

rollup_bundle(
    name = "command_help_bundle",
    entry_point = "prow/cmd/deck/static/command-help/command-help",
    deps = [
        ":command_help",
        "@npm//:dialog-polyfill",
    ],
)

filegroup(
    name = "resources",
    srcs = glob(
        ["**/*"],
        exclude = ["**/*.js"],
    ) + glob(["extensions/*.js"]),
)

filegroup(
    name = "all-scripts",
    srcs = [
        ":command_help_bundle",
        ":index",
        ":plugin_help_bundle",
        ":pr",
        ":tide_bundle",
    ],
)

filegroup(
    name = "static",
    srcs = [
        ":all-scripts",
        ":resources",
    ],
)

filegroup(
    name = "package-srcs",
    srcs = glob(["**"]),
    tags = ["automanaged"],
    visibility = ["//visibility:private"],
)

filegroup(
    name = "all-srcs",
    srcs = [":package-srcs"],
    tags = ["automanaged"],
    visibility = ["//visibility:public"],
)
